---
title: "Regions"
---

```{r setup, echo=F, warning=FALSE, message=F}
source("./_site.R")
```

Regions are the fundamental spatial units of analysis for the Ocean Health Index. Scores are calculated for each region individually and then combined (with an offshore area-weighted average) to produce scores for the entire study area, `r study_area`. These template regions can be modified with some effort. They were identified as the largest subcountry division within `r study_area`.


```{r}
if (!'geojson' %in% names(config)) stop(sprintf('Missing geojson path variable in %s/conf/config.R', dir_scenario))
geojson = normalizePath(file.path(dir_scenario, config$geojson))

# read spatial (can simplify with R package rmapshaper)
if (!file.exists(geojson)) stop(sprintf('GeoJSON file specified in %s/conf/config.R not found: %s', dir_scenario, geojson))
cat(file=stderr(), 'read rgns from geojson\n')
rgns = geojsonio::geojson_read(geojson, what="sp")
if ('rgn_nam' %in% names(rgns@data) & !'rgn_name' %in% names(rgns@data)) rgns@data = rgns@data %>% mutate(rgn_name = rgn_nam)

# get bbox to shrink
bbox_shrink = function(p, pct){
  b = bbox(p)
  dx = (b[3] - b[1]) * (pct/100)
  dy = (b[4] - b[2]) * (pct/100)
  c(b[1] + dx, b[2] + dy, b[3] - dx, b[4] - dy)
}
b = bbox_shrink(rgns, map_shrink_pct)

leaflet() %>%
  addProviderTiles('Stamen.TonerLite') %>%
  addPolygons(
    data = rgns, 
    layerId = ~rgn_id,
    label = mapply(function(n) {
      HTML(sprintf("<em>%s</em>", htmlEscape(n)))},
      rgns$rgn_name, SIMPLIFY = F),
    stroke = TRUE, opacity=0.5, weight=2, fillOpacity = 0.5, smoothFactor = 0.5,
    color = ~colorNumeric('RdYlBu', rgns$rgn_id)(rgn_id)) %>%
  fitBounds(lng1 = b[1], lat1 = b[2], lng2 = b[3], lat2 = b[4]) %>%
  htmlwidgets::onRender("
  function(el, t) {
    var defaultStyle = {
      // stroke, ie polygon border
        opacity:     0.5,
        weight:      2,
      // fill, ie polygon interior
        fillOpacity: 0.5,
    };
    var highlightStyle = {
      // stroke, ie polygon border
        opacity:     0.9,
        weight:      6,
      // fill, ie polygon interior
        fillOpacity: 0.9,
    };

    var myMap = this;
    var layers = myMap._layers;
    for(var i in layers) {
      var layer = layers[i];
      if(layer.label) {
        layer.on('mouseover',
          function(e) {
            this.setStyle(highlightStyle);
            // this.bringToFront();
        });
        layer.on('mouseout',
          function(e) {
            this.setStyle(defaultStyle);
            // this.bringToBack();
        });
      }
    }
  }")
```


OHI `r study_area` has the following regions, each with a unique identifier (ID):

```{r}
datatable(
  rgns@data %>%
  select(rgn_id, rgn_name))
```


IDs for subcountry regions were assigned geographically by increasing longitude. The entire study area `r study_area` has a special region ID of 0.

Exclusive economic zones (EEZs) were identified by [MarineRegions.org](http://www.marineregions.org) and the largest subcountry regions were identified by the generalized administrative boundary database [GADM.org](http://www.gadm.org). Region boundaries were extended offshore to divide the EEZ of `r study_area` into offshore regions. It is possible to use different regions than the ones provided here. See [Create Regions](http://ohi-science.org/pages/create_regions.html) for more details.

Regions were generated with the following inland and offshore buffers relative to the shoreline, which are visualized in the graphic above within increasing transparency away from the shoreline.

- offshore
- offshore1km
- offshore3nm
- inland
- inland1km
- inland25km

These data are available as shapefiles as well as csv files summarizing total area per region. Since shapefiles are binary and can be large, they're best stored outside the Github repository.
