---
title: 'OHI 2016 Supplement: results'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../ohiprep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


```{r data set up, include=FALSE}

#load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(hwriter)
library(RColorBrewer)
library(knitr)
library(googleVis)
library(ohicore)
library(sp)
library(rgdal)
library(DT)
library(broom)
library(nlme)

# Set working directory when not knitting:
setwd("global2016/Reporting")

goals <- c('Index', 'AO', 'SPP', 'BD', 'HAB', 'CP', 'CS', 'CW', 'ECO', 'LE', 'LIV', 'FIS', 'FP', 'MAR', 'ICO', 'SP', 'LSP', 'NP', 'TR')
goal_names <- data.frame(goal=goals, long_goal=c("Index", 
                                                  "Artisanal opportunities",
                                                  "Species condition (Biodiversity)",
                                                  "Biodiversity",
                                                  "Habitat (Biodiversity)",
                                                  "Coastal protection",
                                                  "Carbon storage",
                                                  "Clean water",
                                                  "Economies",
                                                  "Livelihoods & economies",
                                                  "Livelihoods",
                                                  "Fisheries (Food provision)",
                                                  "Food provision",
                                                  "Mariculture (Food provision)",
                                                  "Iconic species (Sense of place)",
                                                  "Sense of place",
                                                  "Lasting special places (Sense of place)",
                                                  "Natural products",
                                                  "Tourism & recreation"))

## General settings to control
scenario <- "2016" #identify scenario of focus (this can be changed to obtain data for other years)
benchmark = 2015  # year that is used for old vs. new OHI analyses
oldCommit = '1d4dcb1abb82dc1d20817acca33c7e7d2ef1b52f' # '4da6b4a1d69d694264ea68456359a939b0c03f9c' = commit for 2014 analysis
colorScheme <- 'new'  # color scheme to use on flower plots ("new" = color reflects size score and is not the original rainbow)
saveFile <- 'global2016' #location where files that are created are to be saved

## General files to load
rgn_names <- read.csv(sprintf('../../eez%s/layers/rgn_global.csv', scenario)) %>%
  dplyr::select(region_id = rgn_id, country = label) %>%
  dplyr::mutate(country = as.character(country))

rgn_names$country[rgn_names$region_id == 212] <- "Gilbert Islands (Kiribati)"
rgn_names$country[rgn_names$region_id == 148] <- "Line Islands (Kiribati)"
rgn_names$country[rgn_names$region_id == 157] <- "Phoenix Islands (Kiribati)"


radicalFile = '2016-11-17' #date extension on the radical data files that are used for all tables/figures

```

### Trend vs scores
(figure out which regions to label)

```{r trend vs score fig 3}

index <- read.csv("data/scores_eez2016.csv") %>%
  select(region_id, country, Index)

vaxis <- index$Index[index$region_id==0]

trend <- read.csv(sprintf("data/trends_%s.csv", scenario)) %>%
  select(region_id, index_trend = Index) %>%
  left_join(index, by= "region_id") %>%
  filter(region_id != 0)


mod <- lm(index_trend ~ Index, data=trend)
summary(mod)

  p <- ggplot2::ggplot(trend, aes(x=Index, y=index_trend)) +
    geom_point(aes(text=paste0("rgn = ", country)), shape=19, size=2, color="gray", alpha = 0.75) +
    geom_point(aes(text=paste0("rgn = ", country)), shape=19, size=2, color="gray", alpha = 0.75) +
    geom_hline(yintercept = 0, color="red", size=.5, linetype=3) +
    geom_vline(xintercept = vaxis, color="red", size=.5, linetype=3) +
    stat_smooth(method=lm, se=FALSE, color="black", size=0.5) +
    theme_bw() + 
    labs(y="Average change in OHI score per year)", x="OHI score (2016)") 

  plotly_fig <- plotly::ggplotly(p)
  plotly_fig
  
### adding labels
  labels1 <- c("Bosnia and Herzegovina", "Vietnam", "Philippines",
              "Eritrea", "Equatorial Guinea", "Nicaragua", "Turkey", "Somalia", "Costa Rica",
          "Glorioso Islands", "American Samoa", "Croatia",
              "Estonia", "New Zealand", "Bahamas")
  
  labels2 <- c("South Georgia and the South Sandwich Islands", "Republique du Congo")
  
setdiff(labels1, trend$country)

trend <- trend %>%
  mutate(label1 = ifelse(country %in% labels1, as.character(country), NA)) %>%
  mutate(label2 = ifelse(country %in% labels2, as.character(country), NA)) 
  

  p <- ggplot2::ggplot(trend, aes(x=Index, y=index_trend)) +
    geom_point(shape=19, size=1.75, color="black", alpha = 0.5) +
    geom_text(aes(label=label1), hjust=0, nudge_x=0.4, size=2.2) + 
    geom_text(aes(label=label2), vjust=0, nudge_y=0.1, nudge_x=-5, size=2.2) +
   geom_point(data=filter(trend, country %in% label1), aes(x=Index, y=index_trend), shape=19, size=1.75, color="darkorange") +
   geom_point(data=filter(trend, country %in% label2), aes(x=Index, y=index_trend), shape=19, size=1.75, color="darkorange") +
    geom_hline(yintercept = 0, color="red", size=.2, linetype=3) +
    geom_vline(xintercept = vaxis, color="red", size=.2, linetype=3) +
      stat_smooth(method=lm, se=FALSE, color="black", size=0.3) +
    theme_bw() + 
    labs(y="Average change in Index score per year", x="OHI score, 2016") 

plot(p)   
ggsave("figures/trend vs score.png", width=7.5, height=5, units=c("in"), dpi=600)
ggsave("figures/trend vs score.tiff", width=6, height=4, units=c("in"), dpi=375)

```

### Comparison of ranks

```{r rank analysis fig6}

index_2016 <- read.csv("data/scores_eez2016.csv") %>%
  select(region_id, country, index2016 = Index) %>%
  filter(region_id != 0) %>%
  arrange(index2016) %>%
  mutate(rank_2016 = min_rank((index2016)))

index_2012 <- read.csv("data/scores_eez2012.csv") %>%
  select(region_id, country, index2012 = Index) %>%
  filter(region_id != 0) %>%
  arrange(index2012) %>%
  mutate(rank_2012 = min_rank((index2012))) %>%
  left_join(index_2016, by=c("region_id", "country")) %>%
  mutate(index_delta = index2016 - index2012) %>%
  mutate(rank_delta = rank_2016 - rank_2012)
  

## compare 2012 vs 2016 ranks
  p <- ggplot2::ggplot(index_2012, aes(x=rank_2012, y=rank_2016)) +
    geom_point(aes(text=paste0("rgn = ", country)), shape=19, size=2, color="black", alpha = 0.5) +
    theme_bw()  + 
    geom_abline(slope = 1, intercept=0, color="red", size=0.5) + 
    labs(y="2016 rank of OHI scores", x="2012 rank of OHI scores") 

plot(p)   
ggsave("figures/ranks_2012_2016.jpg", width=4, height=3)

  plotly_fig <- plotly::ggplotly(p)
  plotly_fig

## compare change in ranks vs change in scores
  
tmp <- filter(index_2012, index_delta<=(-7) & index_delta>=(-8))  
  min(tmp$index_delta)
  max(tmp$index_delta)
  min(tmp$rank_delta)
  max(tmp$rank_delta)
  
  p <- ggplot2::ggplot(index_2012, aes(x=index_delta, y=rank_delta)) +
        #geom_rect(xmax=max(tmp$index_delta), xmin=min(tmp$index_delta), ymin=-145, ymax=max(tmp$rank_delta), alpha=0.01, col="#ffd27f", fill="#ffd27f", size=0) +
     geom_segment(aes(x=-7.52, xend=-7.52, y=-140, yend=-12), size=0.1, color="darkorange3") +
     geom_segment(aes(x=-7.92, xend=-7.92, y=-140, yend=-78), size=0.1, color="olivedrab4") +
     geom_segment(aes(x=-7.5, xend=-25, y=-12, yend=-12), size=0.1, color="darkorange3") +
     geom_segment(aes(x=-7.92, xend=-25, y=-78, yend=-78), size=0.1, color="olivedrab4") +
    annotate("text", x=-15, y=-2, label="Republique du Congo", color="darkorange3", size=2.5) +
    annotate("text", x=-15, y=-70, label="Gilbert Islands", color="olivedrab4", size=2.5) +
    #     geom_segment(aes(x=-6.09, xend=-6.09, y=-145, yend=-8), size=0.4, color="gray30", linetype=3) +
        # geom_rect(xmax=max(tmp$index_delta), xmin=-21, ymin=min(tmp$rank_delta), ymax=max(tmp$rank_delta), alpha=.01, col="#ffd27f", fill="#ffd27f", size=0) +
    geom_point(aes(text=paste0("rgn = ", country)), shape=19, size=1.75, color="gray30", alpha = 0.50) +
    geom_point(data = filter(index_2012, index_delta>0 & rank_delta<0), shape=19, size=1.75, color="#D73027", alpha=0.75) +
    geom_point(data = filter(index_2012, index_delta<0 & rank_delta>0), shape=19, size=1.75, color="#4575B4", alpha=0.75)  +
     geom_point(data = filter(index_2012, country=="Republique du Congo"), shape=19, size=1.75, color="darkorange3")  +
     geom_point(data = filter(index_2012, country=="Gilbert Islands (Kiribati)"), shape=19, size=1.75, color="olivedrab4")  +
    theme_bw()  + 
    coord_cartesian(ylim=c(-125, 100), xlim=c(-20, 11)) +
#    scale_y_reverse() +
   labs(y="Rank change", x="Score change") +
    geom_smooth(method=lm, se=FALSE, color="black", size=0.5)


plot(p)   
ggsave("figures/delta_ranks_scores.png", height=3, width=4)

ggsave("figures/delta_ranks_scores.tiff", width=6, height=4, units=c("in"), dpi=375)

  plotly_fig <- plotly::ggplotly(p)
  plotly_fig
  
  
filter(index_2012, index_delta>0 & rank_delta<0)
filter(index_2012, index_delta<0 & rank_delta>0)

```

## pairwise comparison of goal scores
```{r pairwise comparisons supplement}
index_2016 <- read.csv("data/scores_eez2016.csv") %>%
  filter(region_id != 0) %>%
  select(-c(country, region_id)) %>%
  select(-c(SPP, HAB, ECO, LIV, FIS, MAR, ICO, LSP, Index))

panel.cor <- function(x, y, digits=2, prefix="", cex.cor, ...){
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- abs(cor(x, y, use="na.or.complete"))
  txt <- format(c(r, 0.123456789), digits=digits)[1]
  txt <- paste(prefix, txt, sep="")
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = (cex.cor * r + .15)*3)
}

pairs(index_2016,
      lower.panel=panel.smooth, upper.panel=panel.cor, 
      pch=16, cex=.5)
## export as png with 700 x 700 dimensions



#seeing ones were significant
# panel.cor <- function(x, y, digits=2, prefix="", cex.cor) 
# {
#   usr <- par("usr"); on.exit(par(usr)) 
#   par(usr = c(0, 1, 0, 1)) 
#   r <- abs(cor(x, y)) 
#   txt <- format(c(r, 0.123456789), digits=digits)[1] 
#   txt <- paste(prefix, txt, sep="") 
#   if(missing(cex.cor)) cex <- 0.8/strwidth(txt) 
#   
#   test <- cor.test(x,y) 
#   # borrowed from printCoefmat
#   Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
#                    cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
#                    symbols = c("***", "**", "*", ".", " ")) 
#   
#   text(0.5, 0.5, txt, cex = cex * r) 
#   text(.8, .8, Signif, cex=cex, col=2) 
# }
# pairs(index_2016,
#       lower.panel=panel.smooth, upper.panel=panel.cor)


```

### Carpet plot of trends

```{r carpplot trend supplement}

data <- read.csv(sprintf('../radical_%s.csv', radicalFile)) 

data <- data %>%
  filter(dimension == "score") %>%   # focus only on score data
  filter(region_id != 0) %>%         # this weighted mean includes high seas and Antarctica
  mutate(region_id = ifelse(region_id==300, 0, region_id)) %>%   #convert the 300 (i.e., only eez's averaged to zero)
  filter(region_id <= 250) %>%       # get rid of high seas regions
  filter(region_id != 213)  %>%
  mutate(value = round(value, 0)) %>%
  left_join(rgn_names, by=c('region_id')) %>%
  mutate(country = ifelse(is.na(country), "eez_weighted_avg", as.character(country))) %>%
  group_by(region_id) %>% 
  mutate(meanIndex=mean(value[goal=="Index"])) %>%
  ungroup() %>%
  data.frame()
  

trends <- read.csv(sprintf("data/trends_%s.csv", scenario)) %>%
  gather(goal, "value", -(1:2)) %>%
  select(-region_id, region = country) %>%
  filter(region != "eez_weighted_avg")

region_order <- trends %>%
  filter(goal=="Index") %>%
  arrange(value)

values <-   brewer.pal(11, "RdYlBu")
col.values <- colorRampPalette(values, space = 'Lab')(12)
col.brks  <- c(-100, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 100)

trends$goal <- factor(trends$goal, levels = goals)
trends$region <- factor(trends$region, levels=region_order$region)
trends$trend_category <- cut(trends$value, breaks = col.brks)
  

p <- ggplot(trends, aes(y=region, x=goal, fill=trend_category)) +   
  geom_tile(aes(text = paste0("trend = ", value))) +
  scale_fill_manual(values = col.values, na.value="black") +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
  ylab("") + 
  xlab("") +
  theme_bw()
plot(p)

ggsave("figures/trend_heatplot.png", width = 20, height=25, units="in")
ggplotly(p)

```


### Scores vs. population, HDI, and CHI

```{r pop hdi chi supplement}

index <- read.csv("data/scores_eez2016.csv") %>%
  select(rgn_id = region_id, country, Index) %>%
  filter(rgn_id != 0) 

hdi <- read.csv("../../../ohiprep/globalprep/supplementary_information/v2016/HDI_data.csv") %>%
  select(rgn_id, hdi=value)

# coastal population
pop <- read.csv("../../../ohiprep/globalprep/mar_prs_population/v2016/output/mar_pop_25mi.csv") %>%
  filter(year == 2015) %>%
  select(rgn_id, coastal_pop = popsum) %>%
  mutate(log_coastal_pop = log(coastal_pop + 1))

## chi data
chi <- read.csv("../../../ohiprep/globalprep/supplementary_information/v2016/CHI_data.csv") %>%
  filter(sp_type == "eez") %>%
  select(rgn_id, chi=mean)


data <- index %>%
  left_join(pop, by="rgn_id") %>%
  left_join(chi, by="rgn_id") %>%
  left_join(hdi, by="rgn_id")

data_noNA <- na.omit(data)

mod1 <- lm(Index ~ chi, data=data_noNA)
summary(mod1)
mod2 <- lm(Index ~ hdi, data=data_noNA)
summary(mod2)
mod3 <- lm(Index ~ log_coastal_pop, data=data_noNA)
summary(mod3)
mod4 <- lm(Index ~ chi + hdi, data=data_noNA)
summary(mod4)
mod5 <- lm(Index ~ log_coastal_pop + hdi, data=data_noNA)
summary(mod5)
mod6 <- lm(Index ~ log_coastal_pop + chi, data=data_noNA)
summary(mod6)
mod7 <- lm(Index ~ log_coastal_pop + chi + hdi, data=data_noNA)
summary(mod7)

AIC(mod1, mod2, mod3, mod4, mod5, mod6, mod7)

mod8 <- lm(chi ~ log_coastal_pop, data=data)
summary(mod8)

mod9 <- lm(hdi ~ log_coastal_pop, data=data)
summary(mod9)

p <- ggplot2::ggplot(data, aes(y=Index, x=hdi)) +
    geom_point(shape=19, size=2, color="gray", alpha = 0.5) +
    theme_bw()  + 
    stat_smooth(method=lm, se=FALSE, color="black", size = 0.5)+
    labs(x="Human Development Index", y="OHI index score") 

plot(p)   
ggsave("figures/OHIvsHDI.png", height=4, width=4.5)

p <- ggplot2::ggplot(data, aes(y=Index, x=chi)) +
    geom_point(shape=19, size=2, color="gray", alpha = 0.5) +
    theme_bw()  + 
    stat_smooth(method=lm, se=FALSE, color="black", size = 0.5)+
    labs(x="Cumulative Human Impact", y="OHI index score") 

plot(p)   
ggsave("figures/OHIvsCHI.png", height=4, width=4.5)

p <- ggplot2::ggplot(data, aes(y=Index, x=log_coastal_pop)) +
    geom_point(shape=19, size=2, color="gray", alpha = 0.5) +
    theme_bw()  + 
    stat_smooth(method=lm, se=FALSE, color="black", size = 0.5)+
    labs(x="Coastal population (ln)", y="OHI index score") 

plot(p)   
ggsave("figures/OHIvsCoastalPop.png", height=4, width=4.5)

p <- ggplot2::ggplot(data, aes(x=chi, y=log_coastal_pop)) +
    geom_point(shape=19, size=2, color="gray", alpha = 0.5) +
    theme_bw()  + 
    stat_smooth(method=lm, se=FALSE, color="black", size = 0.5)+
    labs(x="Coastal population (ln)", y="Cumulative Human Impact") 

plot(p)   
ggsave("figures/CHIvsCoastalPop.png", height=4, width=4.5)


```


### Trend analysis
```{r trend analysis}
### prepare data:
data <- read.csv(sprintf('../radical_%s.csv', radicalFile)) 

data <- data %>%
  filter(dimension == "score") %>%   # focus only on score data
  filter(region_id != 0) %>%         # this weighted mean includes high seas and Antarctica
  filter(region_id <= 250) %>%       # get rid of high seas regions
  filter(region_id != 213) %>%
  filter(!is.na(value))

```

```{r fig 1D hist}

data_lm <- data %>%
  group_by(goal, region_id) %>%
  do(mdl = lm(value ~ scenario, data = .))

#data.frame(glance(data_lm, mdl))
results_lm <- tidy(data_lm, mdl) %>%
  ungroup() %>%
  filter(term == "scenario") %>%
  arrange(goal, estimate) %>%
  left_join(goal_names) %>%
  left_join(rgn_names) %>%
  select(goal=goal, goal_long=long_goal, region_name = country, region_id, average_change_per_year = estimate, p.value) %>%
  data.frame()
# 
# weights <- read.csv("../../eez2016/layers/rgn_area.csv") %>%
#   select(region_id=rgn_id, area_km2)
# 
# results_lm <- results_lm %>%
#   left_join(weights, by="region_id")
# 
# summary_lm <- results_lm %>%
#   group_by(goal, goal_long) %>%
#   summarize(mean=mean(average_change_per_year),
#             mean_wt=weighted.mean(average_change_per_year, w=area_km2))


# color coded histogram of trends

trends_hist <- results_lm %>%
  filter(goal=="Index") %>%
  arrange(average_change_per_year)

values <-   brewer.pal(11, "RdYlBu")
values <- colorRampPalette(values, space = 'Lab')(13)[2:13]
col.brks  <- c(-100, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 100)

trends_hist$colors <- cut(trends_hist$average_change_per_year, breaks=col.brks, include.lowest=TRUE, labels=values)
cols <- as.character(unique(trends_hist$colors))


g <- ggplot(trends_hist, aes(x=average_change_per_year)) +
geom_histogram(aes(fill=colors), bins=25, center=1.01, col="gray") +
scale_fill_manual("", breaks=colors, values=cols, guide=FALSE) +
labs(y="Number of regions", x="Average yearly change") +
#geom_vline(xintercept=0, color="red") +
theme_bw()

print(g)

 ggsave("figures/trend_histogram_color.tiff", width=4, height=3, units=c("in"), dpi=300)
 

```


```{r fig 1B hist}

data_scores <- data %>%
  filter(goal=="Index") %>%
  filter(scenario == 2016) 

reds <-  colorRampPalette(c("#A50026", "#D73027", "#F46D43", "#FDAE61", "#FEE090"), space="Lab")(66)
blues <-  colorRampPalette(c("#E0F3F8", "#ABD9E9", "#74ADD1", "#4575B4", "#313695"), space="Lab")(35)
colors <-   c(reds, blues)

col.brks <- seq(0,100, by=1)
col.assign <- cut(col.brks, breaks=col.brks, include.lowest = TRUE)
colors_df <- data.frame(colors_plot=colors, col.assign)
colors_df$col.assign <- as.character(colors_df$col.assign) 

data_scores$col.assign <- cut(data_scores$value, breaks=col.brks, include.lowest=TRUE) 
data_scores$col.assign <- as.character(data_scores$col.assign)

data_scores <- left_join(data_scores, colors_df, by="col.assign") %>%
  mutate(colors_plot = as.character(colors_plot)) %>%
  arrange(value)

cols <- as.character(unique(data_scores$colors_plot))

g <- ggplot(data_scores, aes(x=value)) +
#geom_histogram(aes(fill=colors), bins=25, center=1.01, col="gray") +
geom_histogram(aes(fill=col.assign), bins=31) +  
scale_fill_manual("", values=cols, guide=FALSE) +
xlim(c(0, 100)) +
labs(y="Number of regions", x="Index score") +
theme_bw()

print(g)

 ggsave("figures/score_histogram_color.tiff", width=4, height=3, units=c("in"), dpi=300)

```


## Comparing random effect models
The following analyses indicate that adding the region as a random effect is a good idea, according to AIC.

```{r model check analyze}

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="Index"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="Index"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="AO"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="AO"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="BD"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="BD"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)


model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="CP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="CP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)


model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="CS"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="CS"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)


model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="CW"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="CW"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="FIS"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="FIS"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="FP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="FP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="HAB"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="HAB"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)


model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="ICO"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="ICO"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="MAR"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="MAR"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)


model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="LSP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="LSP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="NP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="NP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="SP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="SP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="SPP"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="SPP"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

model0 <- gls(value ~ 1 + scenario,  data = filter(data, goal=="TR"), method="REML")
model1 <- lme(value ~ 1 + scenario, random = ~1 | region_id, data = filter(data, goal=="TR"), method="REML")
# ctrl <- lmeControl(opt='optim')
# model2 <- lme(value ~ 1 + scenario, random = ~1 + scenario | region_id, data = filter(data, goal=="Index"), 
#               method="REML", control=ctrl)
AIC(model0, model1)
summary(model1)

```

### Random effects model for global trend patterns (data for figure)

```{r trend calcs fig 2}
## Analysis of overall region index scores

nlme_results <- data.frame(goal=goals, trend=NA, p_value=NA)

for(goal in goals){ # goal = "AO"
  mod_data <- data[data$goal == goal, ]
  mdl = lme(value ~ 1 + scenario, random = ~1 | region_id, data = mod_data, method="REML")
  nlme_results$trend[nlme_results$goal == goal] <- mdl$coefficients$fixed[2]
  nlme_results$p_value[nlme_results$goal==goal] <- summary(mdl)$tTable[2,"p-value"]
}

results_lm_summary <- results_lm %>%
  group_by(goal, goal_long) %>%
  summarize(quant_5 = quantile(average_change_per_year, c(0.05)),
            quant_95 = quantile(average_change_per_year, c(0.95)))


nlme_results <- nlme_results %>%
  left_join(results_lm_summary, by="goal") %>%
  arrange(trend) %>%
  mutate(sig = ifelse(p_value < 0.05, "1", "0")) 

### nlme model with eez area weights
eez_area <- read.csv("../../eez2016/layers/rgn_area.csv") %>%
  select(region_id=rgn_id, area_km2) %>%
  mutate(region_id = as.character(region_id))

data_wts <- data %>%
  mutate(region_id = as.character(region_id)) %>%
  left_join(eez_area, by="region_id")

nlme_results_wts <- data.frame(goal=goals, trend_wts=NA, p_value_wts=NA)

for(goal in goals){ # goal = "AO"
  mod_data <- data_wts[data_wts$goal == goal, ]
  mdl = lme(value ~ 1 + scenario, random = ~1 | region_id, data = mod_data, method="REML", weights=~1/area_km2)
  nlme_results_wts$trend_wts[nlme_results_wts$goal == goal] <- mdl$coefficients$fixed[2]
  nlme_results_wts$p_value_wts[nlme_results_wts$goal==goal] <- summary(mdl)$tTable[2,"p-value"]
}

nlme_results <- nlme_results %>%
  left_join(nlme_results_wts, by="goal") %>%
  arrange(trend) %>%
  mutate(sig_wts = ifelse(p_value_wts < 0.05, "1", "0"))


## plot the data (Fig 2A):

levels_goals <- c("Index", as.character(rev(nlme_results$goal_long[nlme_results$goal!="Index"][order(nlme_results$trend[nlme_results$goal!="Index"])])))

nlme_results <- nlme_results %>%
  mutate(goal_long = factor(goal_long, levels = rev(levels_goals))) %>%
  arrange(goal_long)

ggplot(filter(nlme_results, !(goal %in% c("ECO","LIV", "LE"))), 
       aes(x=trend, y=goal_long)) +
  geom_point(size=3, color="#313695") +
  theme_bw() +
  geom_vline(xintercept = 0, color="red", linetype=3) + 
  labs(y="", x="Average change in score per year") +
  xlim(c(-4, 1)) +
#  scale_colour_manual(values = c("#313695", "grey80"), limits=c(1, 0), guide=FALSE) +
  theme(axis.text.y = element_text(angle=0, hjust=1),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(color="grey60", linetype="dashed")) + 
  geom_point(data=filter(nlme_results, !(goal %in% c("ECO","LIV", "LE"))), 
       aes(x=trend_wts, y=goal_long), size=3, color="orange") +
  geom_point(data = filter(nlme_results, !goal %in% c("ECO", "LIV", "LE") & sig==0),
             aes(x=trend, y=goal_long), color="white", size=2) +
  geom_point(data = filter(nlme_results, !goal %in% c("ECO", "LIV", "LE") & sig_wts==0),
             aes(x=trend_wts, y=goal_long), color="white", size=2) +
  annotate("text", label="Unweighted", x=-3.9, y=1.6, hjust=0, family="Ariel", color="#313695", size=2.6) +
  annotate("text", label="Area weighted", x=-2.8, y=1.6, hjust=0, family="Ariel", color="orange", size=2.6)

ggsave("figures/nlme_trend_results.png", width=6, height=4, units=c("in"), dpi=400)

## another plot of the data (Fig 2b)

data_trend <- data %>%
  filter(!(goal %in% c("ECO", "LIV", "LE"))) %>%
  group_by(scenario, goal) %>%
  summarize(min_score = min(value, na.rm=TRUE),
            max_score = max(value, na.rm=TRUE),
            mean_score = mean(value, na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(goal = factor(goal, levels=rev(nlme_results$goal))) %>%
  filter(!is.na(goal))


ggplot(data_trend, aes(x=scenario, y=mean_score)) +
  geom_line() + 
  facet_grid(goal ~ ., scales="free") + 
  theme_bw() +
    theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
   #     strip.text.y = element_text(size = 8, angle = 0))
        strip.text.y = element_blank())
  
ggsave("figures/scores_scenario_grid.png", height=6, width=2, units=c("in"), dpi=400)

```

```{r save model results analyze}

nlme_table <- nlme_results %>%
  select(goal, trend, p_value, quant_5, quant_95)

write.csv(nlme_table, "data/nlme_results_goal_summary.csv", row.names=FALSE)

```

```{r NP changes analyze}

rel = read.csv("../../eez2016/layers/np_harvest_tonnes_relative.csv") 
tons_proc = read.csv("../../eez2016/layers/np_harvest_tonnes.csv")

tons <- read.csv("../../../ohiprep/globalprep/np/v2016/int/tonnes.csv") %>%
  group_by(rgn_id, rgn_name, year, product) %>%
  summarize(tonnes= sum(tonnes, na.rm=TRUE)) %>%
  arrange(product, year)

usd <- read.csv("../../../ohiprep/globalprep/np/v2016/int/usd.csv") %>%
  group_by(rgn_id, rgn_name, year, product) %>%
  summarize(usd= sum(usd, na.rm=TRUE)) %>%
  arrange(product, year)

#### Big declines
#Eritrea
filter(rel, rgn_id==45)
filter(tons_proc, rgn_id==45)
data.frame(filter(tons, rgn_id==45))

tmp <- filter(tons, rgn_id==45 & year >= 1995 & product=="ornamentals")
mean(tmp$tonnes)
sum(tmp$tonnes==0)/length(tmp$tonnes)

tmp <- read.csv("../radical_with_region_names_2016-11-17.csv") %>%
  filter(region_id == 45) %>%
  filter(goal == "NP") %>%
  filter(dimension == "score")

#Estonia
filter(rel, rgn_id==70)
filter(tons_proc, rgn_id==70)
data.frame(filter(tons, rgn_id==70))

# Bonaire
filter(rel, rgn_id==245)
filter(tons_proc, rgn_id==245)
data.frame(filter(tons, rgn_id==245))
data.frame(filter(usd, rgn_id==245))

# Costa Rica
filter(rel, rgn_id==130)
filter(tons_proc, rgn_id==130)
data.frame(filter(tons, rgn_id==130))
data.frame(filter(usd, rgn_id==130))


# US
filter(rel, rgn_id==163)
filter(tons_proc, rgn_id==163)
data.frame(filter(tons, rgn_id==163))
data.frame(filter(usd, rgn_id==163))


# Mozambique
filter(rel, rgn_id==41)
filter(tons_proc, rgn_id==41)
data.frame(filter(tons, rgn_id==41))
data.frame(filter(usd, rgn_id==41))

# Samoa
filter(rel, rgn_id==152)
filter(tons_proc, rgn_id==152)
data.frame(filter(tons, rgn_id==152))
data.frame(filter(usd, rgn_id==152))


```

```{r FIS changes analyze}

trends <- read.csv("data/trends_2016.csv") %>%
  arrange(FIS) %>%
  select(country, region_id, FIS)

### Does status seem to be increasing?
fis_status <- read.csv("../../global2016/radical_2016-11-17.csv") %>%
  filter(region_id != 0) %>%
  filter(region_id != 213) %>%
  filter(region_id <= 250) %>%
  filter(dimension=="status") %>%
  filter(goal == "FIS")

data_lm_status <- fis_status %>%
  group_by(region_id) %>%
  do(mdl = lm(value ~ scenario, data = .))

#data.frame(glance(data_lm, mdl))
lm_status <- tidy(data_lm_status, mdl) %>%
  ungroup() %>%
  filter(term == "scenario") %>%
  arrange(estimate) %>%
  data.frame()

median(lm_status$estimate)
mean(lm_status$estimate)
sum(lm_status$estimate>0)
sum(lm_status$estimate<0)

### Does trend seem to be increasing?
fis_trend <- read.csv("../../global2016/radical_2016-11-17.csv") %>%
  filter(region_id != 0) %>%
  filter(region_id != 213) %>%
  filter(region_id <= 250) %>%
  filter(dimension=="trend") %>%
  filter(goal == "FIS") %>%
  filter(scenario == 2016)

median(fis_trend$value)
mean(fis_trend$value)
sum(fis_trend$value>0)
sum(fis_trend$value<0)

fis_trend <- read.csv("../../global2016/radical_2016-11-17.csv") %>%
  filter(region_id != 0) %>%
  filter(region_id != 213) %>%
  filter(region_id <= 250) %>%
  filter(dimension=="trend") %>%
  filter(goal == "FIS")

data_lm_trend <- fis_trend %>%
  group_by(region_id) %>%
  do(mdl = lm(value ~ scenario, data = .))

#data.frame(glance(data_lm, mdl))
lm_trend <- tidy(data_lm_trend, mdl) %>%
  ungroup() %>%
  filter(term == "scenario") %>%
  arrange(estimate) %>%
  data.frame()

median(lm_trend$estimate)
mean(lm_trend$estimate)
sum(lm_trend$estimate>0)
sum(lm_trend$estimate<0)


### Pressures
fis_pressures <- read.csv("../../global2016/radical_2016-11-17.csv") %>%
  filter(region_id != 0) %>%
  filter(region_id != 213) %>%
  filter(region_id <= 250) %>%
  filter(dimension=="pressures") %>%
  filter(goal == "FIS")

data_lm_pressures <- fis_pressures %>%
  group_by(region_id) %>%
  do(mdl = lm(value ~ scenario, data = .))

#data.frame(glance(data_lm, mdl))
lm_pressures <- tidy(data_lm_pressures, mdl) %>%
  ungroup() %>%
  filter(term == "scenario") %>%
  arrange(estimate) %>%
  data.frame()

median(lm_pressures$estimate)
mean(lm_pressures$estimate)
sum(lm_pressures$estimate>0)
sum(lm_pressures$estimate<0)



## Norway
catch <- read.csv("../../eez2016/layers/fis_meancatch.csv") %>%
  filter(rgn_id == 223) %>%
  filter(year==2010) %>%
  arrange(mean_catch)

bmsy <- read.csv("../../eez2016/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id == 223) %>%
  arrange(stock_id, year) %>%
  group_by(stock_id) %>%
  mutate(avg_bbmsy = mean(bbmsy)) %>%
  ungroup()

data_lm_low <- bmsy %>%
  filter(avg_bbmsy < 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

#data.frame(glance(data_lm, mdl))
results_lm_low <- tidy(data_lm_low, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_low$estimate>0)
sum(results_lm_low$estimate<0)
median(results_lm_low$estimate)

data_lm_high <- bmsy %>%
  filter(avg_bbmsy > 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

results_lm_high <- tidy(data_lm_high, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_high$estimate>0)
sum(results_lm_high$estimate<0)
median(results_lm_high$estimate)



## Vietnam
catch <- read.csv("../../eez2016/layers/fis_meancatch.csv") %>%
  filter(rgn_id == 207) %>%
  filter(year==2010) %>%
  arrange(mean_catch)

bmsy <- read.csv("../../eez2016/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id == 207) %>%
  arrange(stock_id, year) %>%
  group_by(stock_id) %>%
  mutate(avg_bbmsy = mean(bbmsy)) %>%
  ungroup()

data_lm_low <- bmsy %>%
  filter(avg_bbmsy < 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

#data.frame(glance(data_lm, mdl))
results_lm_low <- tidy(data_lm_low, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_low$estimate>0)
sum(results_lm_low$estimate<0)
median(results_lm_low$estimate)

data_lm_high <- bmsy %>%
  filter(avg_bbmsy > 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

results_lm_high <- tidy(data_lm_high, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_high$estimate>0)
sum(results_lm_high$estimate<0)
median(results_lm_high$estimate)


## Madagascar
catch <- read.csv("../../eez2016/layers/fis_meancatch.csv") %>%
  filter(rgn_id == 42) %>%
  filter(year==2010) %>%
  arrange(mean_catch)

bmsy <- read.csv("../../eez2016/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id == 42) %>%
  arrange(stock_id, year) %>%
  group_by(stock_id) %>%
  mutate(avg_bbmsy = mean(bbmsy)) %>%
  ungroup()

data_lm_low <- bmsy %>%
  filter(avg_bbmsy < 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

#data.frame(glance(data_lm, mdl))
results_lm_low <- tidy(data_lm_low, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_low$estimate>0)
sum(results_lm_low$estimate<0)
median(results_lm_low$estimate)

data_lm_high <- bmsy %>%
  filter(avg_bbmsy > 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

results_lm_high <- tidy(data_lm_high, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_high$estimate>0)
sum(results_lm_high$estimate<0)
median(results_lm_high$estimate)



## Canada
catch <- read.csv("../../eez2016/layers/fis_meancatch.csv") %>%
  filter(rgn_id == 218) %>%
  filter(year==2010) %>%
  arrange(mean_catch)

bmsy <- read.csv("../../eez2016/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id == 218) %>%
  arrange(stock_id, year) %>%
  group_by(stock_id) %>%
  mutate(avg_bbmsy = mean(bbmsy)) %>%
  ungroup()

data_lm_low <- bmsy %>%
  filter(avg_bbmsy < 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

#data.frame(glance(data_lm, mdl))
results_lm_low <- tidy(data_lm_low, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_low$estimate>0)
sum(results_lm_low$estimate<0)
median(results_lm_low$estimate)

data_lm_high <- bmsy %>%
  filter(avg_bbmsy > 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

results_lm_high <- tidy(data_lm_high, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_high$estimate>0)
sum(results_lm_high$estimate<0)
median(results_lm_high$estimate)



## Norfolk Island
catch <- read.csv("../../eez2016/layers/fis_meancatch.csv") %>%
  filter(rgn_id == 3) %>%
  filter(year==2010) %>%
  arrange(mean_catch)

bmsy <- read.csv("../../eez2016/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id == 3) %>%
  arrange(stock_id, year) %>%
  group_by(stock_id) %>%
  mutate(avg_bbmsy = mean(bbmsy)) %>%
  ungroup()

tmp <- read.csv("../../../ohiprep/globalprep/fis/v2016/data/fis_bbmsy_gf.csv") %>%
  filter(stock_id == "Thunnus_alalunga-81")

bmsy %>%
  group_by(year) %>%
  summarize(median_bbmsy = median(bbmsy))

# Thunnus_alalunga
# Arripis_trutta
# Xiphias_gladius
# Scomber_australasicus
# Arripis_trutta
# Xiphias_gladius

data_lm_low <- bmsy %>%
  filter(avg_bbmsy < 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

#data.frame(glance(data_lm, mdl))
results_lm_low <- tidy(data_lm_low, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_low$estimate>0)
sum(results_lm_low$estimate<0)
median(results_lm_low$estimate)

data_lm_high <- bmsy %>%
  filter(avg_bbmsy > 1) %>%
  filter(year >= 2006) %>%
  group_by(stock_id) %>%
  do(mdl = lm(bbmsy ~ year, data = .))

results_lm_high <- tidy(data_lm_high, mdl) %>%
  ungroup() %>%
  filter(term == "year") %>%
  arrange(estimate) %>%
  data.frame()

sum(results_lm_high$estimate>0)
sum(results_lm_high$estimate<0)
median(results_lm_high$estimate)


```



```{r CP changes analyze}

trends <- read.csv("data/trends_2016.csv") %>%
  arrange(CP) %>%
  select(country, region_id, CP)

### Does status seem to be increasing?
cp_status <- read.csv("../../global2016/radical_with_region_names_2016-11-17.csv") %>%
  filter(region_id != 0) %>%
  filter(region_id != 213) %>%
  filter(region_id <= 250) %>%
  filter(dimension=="score") %>%
  filter(goal == "CP") %>%
  spread(scenario, value) %>%
  data.frame()

cp_status$diff <- cp_status$X2016 - cp_status$X2012

cp_status <- cp_status %>%
  arrange(diff)

```


```{r Norfolk Island}

read.csv("../../global2016/radical_with_region_names_2016-11-17.csv") %>%
  filter(region_name == "Norfolk Island") %>%
  filter(dimension == "status") %>%
  spread(goal, value)
49-29
92-73

## TR goal
read.csv("../../eez2016/layers/tr_jobs_pct_tourism.csv") %>%
  filter(rgn_id==3)

read.csv("../../eez2012/layers/tr_jobs_pct_tourism.csv") %>%
  filter(rgn_id==3)

read.csv("../../eez2016/layers/tr_sustainability.csv") %>%
  filter(rgn_id==3)
read.csv("../../eez2012/layers/tr_sustainability.csv") %>%
  filter(rgn_id==3)

read.csv("../../eez2016/layers/tr_travelwarnings.csv") %>%
  filter(rgn_id==3)
```


```{trend barplot fig 4 and supplement}

data <- read.csv("data/trends_2016.csv") %>%
  filter(region_id != 0) %>%
  select(-region_id, -SPP, -HAB, -ECO, -LIV, -FIS, -MAR, -ICO, -LSP) %>%
  gather("goal", "trend", -country) %>%
  left_join(goal_names, by='goal') %>%
  select(country, goal=long_goal, trend)

index <- filter(data, goal=="Index") %>%
  mutate(country = as.character(country)) %>%
  arrange(trend)

data <- data %>%
  mutate(country=as.character(country)) %>%
  mutate(country = factor(country, levels=index$country))

myPalette <- brewer.pal(10, "Spectral")

p <- ggplot(data=filter(data, goal != "Index"), aes(x=country, y=trend, fill=goal)) + 
  geom_bar(stat="identity") +
  scale_fill_manual(values=myPalette) +
  coord_flip() +
  theme_bw() +
  labs(y="Average change in score per year", x="") + 
  guides(fill=guide_legend(reverse=TRUE)) +
  theme(axis.text.y=element_text(size=10),
        legend.justification=c(1,0), legend.position=c(.3,.875)) +
  geom_point(data=index, aes(y=trend, x=country), fill="black", shape="|") +
  geom_hline(yintercept=0, color="black")
p

ggsave('Trend_barplot.pdf', height=25, width=10)
ggsave('Trend_barplot.png', height=25, width=10)

max <- length(index$country)
countries_mid <- c("Johnston Atoll", "Jarvis Island", "Ile Europa", "Libya", "Russia",
                   "Cook Islands", "Norfolk Island", "Lithuania", "Egypt", "Sao Tome and Principe")

regions_subset <- rbind(index[1:15, ], index[index$country %in% countries_mid, ], index[(max-14):max, ])
regions_subset <- as.character(regions_subset$country)  

data_subset <- data %>%
  mutate(country = as.character(country)) %>%
  filter(country %in% regions_subset) %>%
  mutate(country = factor(country, levels=index$country))
  
index_subset <- filter(data_subset, goal=="Index")  


p <- ggplot(data=filter(data_subset, goal != "Index"), aes(x=country, y=trend, fill=goal)) + 
  geom_bar(stat="identity") +
  scale_fill_manual(values=myPalette) +
  coord_flip() +
  theme_bw() +
  labs(y="Average change in score per year", x="") + 
  guides(fill=guide_legend(reverse=TRUE)) +
  theme(axis.text.y=element_text(size=10),
        legend.justification=c(1,0), legend.position=c(.3,.60)) +
  geom_point(data=index_subset, aes(y=trend, x=country), fill="black", shape="|", size=4) +
  geom_vline(xintercept=15.5, color="black") +
  geom_vline(xintercept=26.5, color="black") +
  geom_hline(yintercept=0, color="black") +
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
p
ggsave('Trend_barplot_subset.pdf', height=8, width=10)
ggsave('Trend_barplot_subset.png', height=8, width=10)
ggsave('Trend_barplot_subset.tiff', height=8, width=10, units=c("in"), dpi=600)


```

