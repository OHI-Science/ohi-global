---
title: 'S2 Methods'
csl: methods-in-ecology-and-evolution.csl
output:
  html_document:
    code_folding: show
    highlight: haddock
    includes:
      in_header: ../../ohiprep/src/templates/ohi_hdr.html
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
bibliography: OHI.bib
---

Compiled on `r date()`.


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

## Running:
 # 1. Run CombineLayers.R to create the relevant Rmd file for data layers (if any changes to these files), creates layers_all.R
 # 2. Save a new OHI.bib file from Zotero if changes to referenes
 # 3. Run BIBcorrect.R to fix a few weird things in the OHI.bib file
 # 4. Knit this file. 

# To do: 
#   * Casey to review models
#   * Courtney about resilience wording for weights


# tables in Rmd: https://rpubs.com/benmarwick/tables-rmarkdown

library(knitr)
library(xtable)
library(pander)
library(dplyr)
library(tidyr)
library(ggplot2)

options(knitr.kable.NA = '')

# If there are changes to the references, run BIBcorrect.R!!!

# exclude when knitting
# setwd("global_supplement")

assessmentYear <- 2016

# sections to run:
ten_goals <- TRUE
index_scores <- TRUE
table_regions <- TRUE
goal_model <- TRUE
trend <- TRUE
pressure <- TRUE
resilience <- TRUE

```

# The Ocean Health Index

We measure ocean health as the sustainable delivery of ten widely-held public goals for ocean ecosystems (Table 1.1). These goals represent the full suite of benefits that people want and need from the ocean, including the traditional ‘goods and services’ people often consider (e.g., fish to eat, coastal protection from nearshore habitats) as well as benefits less commonly accounted for, such as cultural values or biodiversity.  The Index recognizes that people are part of coastal and ocean systems and thus values both conservation and extractive use.   

**Table 1.1. The 10 goals of the Ocean Health Index**
```{r ten_goals, eval = ten_goals, echo=FALSE}

goals <- read.csv("tables/ten_goals.csv") %>%
  select(Goal, Description) %>%
  arrange(Goal)

kable(goals)
```

The global Ocean Health Index has been assessed every year since 2012. The primary goal of each yearly assessment is to calculate a new year of scores using the most recent data released by the data sources.  Often, in addition to incorporating an additional year of data, we make improvements to models or data sources.  To ensure that scores for all years are calculated using the same methods and data sources, and can thus be compared, we recalculate scores for previous scenario years during each assessment.  For the 2016 assessment, for example, in addition to calculating new 2016 scores, we include recalculated scores from 2012 to 2015.  Consequently, comparisons among years should always be performed using data from the same assessment year so trends in scores reflect changes to ocean health rather than changes to methods.  

Not all data layers are reported through the most current assessment year, and consequently, the OHI scores are calculated using the most recent year of available data.  Details on which years are used for each data layer are provided in Table 6.2. 

The Index is designed to be flexible to accommodate different scales and geographies of interest and different and new types of data [@lowndes_best_2015, http://ohi-science.org]. For more information about the philosophy of the Ocean Health Index and model development see Halpern et al. (2012, 2015) and http://ohi-science.org/ohi-global/, which includes information about downloading global ocean health data.

# Data inclusion and data gaps

Ideally, regional and local assessments should use the best available data, but this decision limits the ability to compare across scales. For direct comparisons among locations to be valid, they must use consistent data.  For this reason, we focused on using global datasets so differences in Index scores across regions would be driven by differences in ocean health rather than variation in the data. Although, in reality, many global datasets are compilations of local or regional datasets and their quality varies spatially. In some cases data for a particular component or dimension of a goal were available for most but not all countries. Gaps in these data were known to not be true zero values. Rather than exclude these data layers, we employed several different methods to fill these data gaps [@frazier_mapping_2016].  

These guidelines both motivated and constrained our methods. The development of the model frameworks for each goal (including reference points) was heavily dictated by the availability of global datasets. And, ultimately, several key elements related to ocean health could not be included due to lack of existing or appropriate global datasets. As new and better data become available in the future, details of how goals or dimensions are modeled will likely change, although the framework we have developed can accommodate these changes. 

For Index scores to be comparable, every region must have a value for each data layer included in the analysis, unless it is known to not be relevant to a region. In other words, missing data are not acceptable [@burgass_navigating_2017]. Adhering to this criterion is critical to avoid influencing the Index score simply because of inclusion (or absence) of a particular data layer for any reporting region.  

Gaps in data are common; many developing countries lack the resources to gather detailed datasets, and even developed, data-rich countries have inevitable data gaps.  We use a variety of methods to estimate missing data, including: averages of closely related groups (e.g., regions sharing ecological, spatial, political attributes; taxonomic groups; etc.), spatial or temporal interpolation (e.g., raster or time-series data), and predictive models (e.g., regression analysis, machine learning, etc.). Gapfilling is a major source of uncertainty, especially for certain goals and regions. Given how common gaps in data are, clear documentation of gapfilling is a critical step of index development because it provides a measure of the reliability of index scores.  

One of the ongoing goals of the Ocean Health Index (OHI) has been to improve our approach to dealing with missing data, by quantifying the potential influence of gapfilled data on index scores, and developing effective methods of tracking, quantifying, and communicating this information [@frazier_mapping_2016].

# Regions

For the global assessment, we calculate Ocean Health Index scores for 220 coastal countries and territorial regions (Table 3.1).  Regions are based on Exclusive Economic Zone boundaries [EEZ, @claus_marine_2012].  However, we aggregate some EEZ regions to the level of country (e.g., Hawaii is estimated as part of the larger U.S.).  We have also modified some boundaries [@halpern_index_2012; @halpern_patterns_2015].  We do not estimate OHI values for disputed or unclaimed areas.

**Table 3.1. Global regions**

```{r table_regions, eval = table_regions, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}

regions <- read.csv("../../ohiprep/src/LookupTables/eez_rgn_2013master.csv", stringsAsFactors = FALSE) %>%
  filter(rgn_typ == "eez") %>%
  filter(rgn_id_2013 <= 250) %>%
  filter(rgn_id_2013 != 213) %>%
  select(region_id = rgn_id_2013, region_name = rgn_nam_2013, iso_id = eez_iso3, administrative_country=sov_nam) %>%
  unique() %>%
  arrange(region_id) %>%
  mutate(status = ifelse(region_name == administrative_country, "country", "territory")) %>%
  mutate(administrative_country = ifelse(region_name == administrative_country, "", administrative_country)) %>%
  select("region"=region_name, "region ID"=region_id, "ISO code"=iso_id, type=status, "administrative country" =administrative_country) %>%
  arrange(region)

kable(regions)
```

# Models

## Regional and global Index scores
```{r child = 'index_scores.Rmd', eval=index_scores}

```

## Goal scores
```{r child = 'goal_model.Rmd', eval=goal_model}

```

## Likely future status dimensions
Three dimensions are used to calculate likely future status: trends, pressure, and resilience.  This section describes the calculations underlying these three dimensions.

```{r child = 'trend.Rmd', eval=trend}

```

```{r child = 'pressure.Rmd', eval=pressure}

```

```{r child = 'resilience.Rmd', eval=resilience}

```


# Goal models and data
In this section we describe how the current status and trend of each goal was calculated. We also indicate which data layers were used to calculate current status, trend (if different from current status), pressure, and resilience.  

The R code used to calculate the goal model is located [here](https://github.com/OHI-Science/ohi-global/blob/draft/eez2016/conf/functions.R) (scroll to the appropriate goal function). To learn more about the data layers used in the model calculations see Section 6: Description of data layers.  Table 6.1 includes links to the code and data used to create the data layers (current calculations are in the folder with the most recent year).  Table 6.2 describes the data sources used to create the data layers.  


```{r goal functions, echo=FALSE, warning=FALSE, error=FALSE, results="asis"}

## data and functions used to list data layers in each goal

# data with information
layers <- read.csv("../eez_layers_meta_data/layers_eez_base.csv")
targets <- read.csv("../eez_layers_meta_data/layers_eez_targets.csv")
layers_web <- "http://ohi-science.org/ohi-global/layers.html"

# function
data_layers <- function(dimension, goal){ # goal = "AO"; dimension=c("status", "trend")
  
  st <- targets[targets$goal == goal, ]
  st <- st[st$dimension %in% dimension, ]
  
st <- st %>%
  select(layer) %>%
  unique()

st_layers <- filter(layers, layer %in% st$layer) %>%
  mutate(web_name = gsub(" ", "_", name)) %>%
  mutate(web_name = tolower(web_name)) %>%
  mutate(web_name = gsub("/", "", web_name)) %>%
  mutate(info = sprintf("[%s](%s#%s) (%s): %s", name, layers_web, web_name, layer, description))

cat(paste(st_layers$info, collapse="\n\n"))
}

```


```{r child = 'goal_descriptions/AO_long.Rmd'}

```

```{r child = 'goal_descriptions/BD_long.Rmd'}

```

```{r child = 'goal_descriptions/HAB_long.Rmd'}

```

```{r child = 'goal_descriptions/SPP_long.Rmd'}

```

```{r child = 'goal_descriptions/CP_long.Rmd'}

```

```{r child = 'goal_descriptions/CS_long.Rmd'}

```

```{r child = 'goal_descriptions/CW_long.Rmd'}

```

```{r child = 'goal_descriptions/FP_long.Rmd'}

```

```{r child = 'goal_descriptions/FIS_long.Rmd'}

```

```{r child = 'goal_descriptions/MAR_long.Rmd'}

```

```{r child = 'goal_descriptions/LE_long.Rmd'}

```

```{r child = 'goal_descriptions/ECO_long.Rmd'}

```

```{r child = 'goal_descriptions/LIV_long.Rmd'}

```

```{r child = 'goal_descriptions/NP_long.Rmd'}

```

```{r child = 'goal_descriptions/SP_long.Rmd'}

```

```{r child = 'goal_descriptions/ICO_long.Rmd'}

```

```{r child = 'goal_descriptions/LSP_long.Rmd'}

```

```{r child = 'goal_descriptions/TR_long.Rmd'}

```

# Description of data layers

###Tables describing data layers (Table 6.1) and sources (Table 6.2)

**Table 6.1. Data layers of `r assessmentYear` global OHI assessment**
A brief overview of all the data layers used to calculate the global OHI.  The "Data layer" variable provides links to a full description of the data layer.  The "Description" variable provides link/s to the data preparation scripts (when available).   See Table 6.2 for a description of the data sources used to create these data layers.

```{r DataLayer Table, echo=FALSE, warning=FALSE, error=FALSE, messages=FALSE}

## Get list of layers, name, description:
base <- read.csv("../eez_layers_meta_data/layers_eez_base.csv") %>%
  mutate(Name = paste0("[", name, "](", "http://ohi-science.org/ohi-global/layers#", layer, ")")) %>%
  select(layer, Name, Description = description)

## Get Dimension/targets
targets <- read.csv("../eez_layers_meta_data/layers_eez_targets.csv", stringsAsFactors = FALSE) %>%
  mutate(goal = ifelse(dimension %in% c("pressure", "resilience", "spatial", "weighting"), dimension, goal)) %>%
  select(layer, goal) %>%
    unique() %>%
  group_by(layer) %>%
  summarize(Dimension = paste(goal, collapse = ", "))

# setdiff(base$layer, targets$layer) # the sp_alien_species ends up not being used
# setdiff(targets$layer, base$layer)

data <- left_join(targets, base, by="layer")

## Get data prep url (will be a link in description)
url <- read.csv("../eez_layers_meta_data/layers_eez_methods.csv") %>%
  filter(variable == "dataprep_url_2016") %>%
  group_by(layer) %>%
  mutate(N = 1) %>%
  mutate(method_count = cumsum(N)) %>%
  mutate(total_methods = sum(N)) %>%
  mutate(count = sum(N)) %>%
  mutate(url_link = ifelse(count==1,  paste0("[data prep]", "(", variable_data, ")"), 
                           paste0("[data prep ", method_count, "](", variable_data, ")"))) %>%
  summarize(url_link = paste(url_link, collapse = ", ")) %>%
  select(layer, url_link) %>%
  ungroup()

data <- left_join(data, url, by="layer") %>%
  mutate(Description = paste0(Description, " (", url_link, ")")) %>%
  select(layer, Name, Description, Dimension)

## get references:
refs <- read.csv("../eez_layers_meta_data/layers_eez_methods.csv") %>%
  filter(variable == "ds_reference") %>%
  select(layer, variable_data) %>%
  unique() %>%
  mutate(ref = paste0("@", variable_data)) %>%
  group_by(layer) %>%
  summarize(reference = paste(ref, collapse = "; ")) %>%
  ungroup() %>%
  #mutate(reference = paste0("[", reference, "]")) %>%
  select(layer, References=reference)
  
# setdiff(data$layer, refs$layer) # these are reasonable layers to not have references

data <- data %>%
  left_join(refs, by="layer")

### Get method updates
updates <- read.csv("../eez_layers_meta_data/layers_eez_methods.csv") %>%
  filter(variable == "methods_update_2016") %>%
  select(layer, Updates=variable_data) %>%
  unique()

data <- data %>%
  left_join(updates, by="layer") %>%
  select(-layer) %>%
  select(Layer=Name, Description, Dimension, References, Updates) %>%
  arrange(Dimension)

kable(data)

```


**Table 6.2. Data sources used to create data layers for `r assessmentYear` global OHI assessment**
A brief overview of the data sources used to calculate the global OHI.

```{r DataSources Table, echo=FALSE, warning=FALSE, error=FALSE, messages=FALSE}

### Get datasource primary data

## get relevant data layers
layers <- read.csv("../eez_layers_meta_data/layers_eez_methods.csv") %>%
  filter(variable == "ds_reference") %>%
  select(layer, ds_reference = variable_data) %>%
  unique()

## get layer names
layer_names <- read.csv("../eez_layers_meta_data/layers_eez_base.csv")%>%
  select(layer, name)

layers <- layers %>%
  left_join(layer_names, by="layer") %>%
  group_by(ds_reference) %>%
  summarize(Layers = paste(name, collapse=", ")) %>%
  mutate(Layers = gsub("NA, ", "", Layers))
  

## get source data
ds_source <- read.csv("../eez_layers_meta_data/layers_eez_data_sources.csv") %>%
  left_join(layers, by="ds_reference") %>%
  mutate(ds_reference = paste0("@", ds_reference)) %>%
  select(Reference = ds_reference, Description = ds_description, Layers, Years=ds_years, Resolution = ds_native_resolution, Updated = ds_updated_2016)

kable(ds_source)

```



```{r child = 'layers_all.Rmd'}
## Need to run CombineLayers.R to create the relevant Rmd file

```

# References